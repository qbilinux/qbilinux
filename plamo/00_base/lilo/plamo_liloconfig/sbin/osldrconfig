#!/bin/sh

################################################################
# WindowsNT/2000/XP の OS ローダー + LILO の簡易設定スクリプト
################################################################

TMP=/tmp

# Figure out if we're installing from the hard drive
if [ -r $TMP/SeTT_PX ]; then
 T_PX="`cat $TMP/SeTT_PX`"
else
 if [ "$T_PX" = "" -a ! "$1" = "" ]; then
  T_PX=$1
 else
  T_PX=/
 fi
fi

if [ ! "`echo $T_PX|sed -e's/.*\/$//'`" = "" ] ; then
  T_PX="${T_PX}/"
fi

# Set color menu mode by default:
COLOR=on
#
PROBE=/sbin/fdisk

################################################################

LANG=C $PROBE -l > $TMP/probe$$

LINUXP=`cat $TMP/probe$$ | tr -d '*'|tr -s ' '|cut -f 1,5,6 -d ' ' \
|grep -e '83 Linux'|cut -f 1,3 -d ' '`
LINUXP_NUM=`cat $TMP/probe$$ | tr -d '*'|tr -s ' '|cut -f 1,5,6 -d ' ' \
|grep -e '83 Linux'|wc -l`
DOSP=`cat $TMP/probe$$     | tr -d '*'|tr -s ' '|grep -e FAT \
|cut -f 1,6 -d ' '`
DOSP_NUM=`cat $TMP/probe$$ | tr -d '*'|grep -e FAT|wc -l`
NTP=`cat $TMP/probe$$      | tr -d '*'|tr -s ' '|grep -e NTFS \
|cut -f 1,6 -d ' '`
NTP_NUM=`cat $TMP/probe$$  | tr -d '*'|grep -e NTFS|wc -l`

rm -f $TMP/probe$$

WINP_NUM=`expr ${DOSP_NUM} + ${NTP_NUM}`

if [ $WINP_NUM = 0 ] ; then
  dialog --title "エラー" --msgbox "NTFSかFATのパーティションがありません!" \
6 65
  exit
fi
if [ $LINUXP_NUM = 0 ] ; then
  dialog --title "エラー" --msgbox "Linuxのパーティションがありません!" 6 65
  exit
fi

RECYCLE_LILO=0
if [ -f $T_PX/etc/lilo.conf ] ; then
  dialog --title "lilo.conf が見つかりました" \
--menu "すでに lilo.conf が存在します．\n\
lilo.conf を再作成しますか？" 11 60 3 \
"Recycle" "既存のlilo.confのままでLILOを再インストール" \
"New" "lilo.confを作成しなおす" \
"Exit" "中止" 2> $TMP/reply$$
  if [ $? = 1 -o $? = 255 ]; then
    rm -f $TMP/reply$$
    exit
  fi
  REPLY="`cat $TMP/reply$$`"
  rm -f $TMP/reply$$
  if [ "$REPLY" = "Exit" ] ; then
    exit
  fi
  if [ "$REPLY" = "Recycle" ] ; then
    RECYCLE_LILO=1
  fi
fi

################################################################
while [ 1 ] ; do
################################################################

dialog --title "Windowsパーティションの選択" \
--menu "WindowsNT,2000,XPのOSローダーがインストールされている\n\
パーティションは？" 21 60 13 \
$DOSP $NTP \
"Exit" "中止" 2> $TMP/reply$$

if [ $? = 1 -o $? = 255 ]; then
  rm -f $TMP/reply$$
  exit
fi
REPLY="`cat $TMP/reply$$`"
rm -f $TMP/reply$$
if [ "$REPLY" = "Exit" ] ; then
  exit
fi
PARTITION_NT=$REPLY

################################################################

if [ "`echo $DOSP|grep \"$PARTITION_NT\"`" = "" ] ; then
  FS_TYPE=ntfs
else
  FS_TYPE=vfat
fi

################################################################

MOUNT_POINT=`mount |grep "$PARTITION_NT "|cut -f 3 -d ' '`

if [ ! "$MOUNT_POINT" = "" ] ; then
  if [ ! -f $MOUNT_POINT/boot.ini ] ; then
    dialog --title "エラー" --msgbox "$PARTITION_NT に boot.ini \
がありません!" 6 65
    continue
  fi
  cat $MOUNT_POINT/boot.ini > $T_PX/boot/boot.ini
else
  MOUNT_POINT=$TMP/nt$$
  mkdir $MOUNT_POINT
  mount -t $FS_TYPE $PARTITION_NT $MOUNT_POINT
  cat $MOUNT_POINT/boot.ini > $T_PX/boot/boot.ini
  if [ ! -f $MOUNT_POINT/boot.ini ] ; then
    dialog --title "エラー" --msgbox "$PARTITION_NT に boot.ini \
がありません!" 6 65
    continue
  fi
  umount $MOUNT_POINT
  rmdir $MOUNT_POINT
fi

################################################################

if [ $RECYCLE_LILO = 1 ] ; then

  PARTITION_LINUX="`cat $T_PX/etc/lilo.conf|tr -d ' '|grep '^boot=' \
|sed -e 's/boot=//'`"

else

  dialog --title "Linuxパーティションの選択" \
--menu "Linuxのルートパーティションは？\n\
このパーティションのPBRにLILOをインストールします．" 21 60 13 \
$LINUXP \
"Begin" "最初からやりなおし" 2> $TMP/reply$$

  if [ $? = 1 -o $? = 255 ]; then
    rm -f $TMP/reply$$
    exit
  fi
  REPLY="`cat $TMP/reply$$`"
  rm -f $TMP/reply$$
  if [ "$REPLY" = "Begin" ] ; then
    continue
  fi
  PARTITION_LINUX=$REPLY

################################

  dialog --title "LILO の append= 行の追加(無くても構いません)" \
--inputbox "起動時にカーネルパラメータをわたす場合に指定してくだ\nさい．" \
9 60 2> $TMP/reply$$
  REPLY="`cat $TMP/reply$$`"
  rm -f $TMP/reply$$
  APPEND=$REPLY

################################

  cat <<EOF > $T_PX/etc/lilo.conf
# LILO configuration file
# generated by 'liloconfig'
#
# Start LILO global section
append = "$APPEND"
boot = $PARTITION_LINUX
#compact        # faster, but won't work on all systems.
# delay = 5
vga = normal    # force sane state
lba32
# ramdisk = 0     # paranoia setting
# End LILO global section
# Linux bootable partition config begins
image = /boot/vmlinuz
  root = $PARTITION_LINUX
  label = Linux
  append = "vga16 unicon=eucjp"
  read-only # Non-UMSDOS filesystems should be mounted read-only for checking
# Linux bootable partition config ends
EOF

fi

################################################################

dialog --infobox "\nLinux Loader をインストール中..." 5 40
if [ "$T_PX" = "/" ]; then
  /sbin/lilo 1> /dev/null 2> /dev/null
else
  $T_PX/sbin/lilo -r $T_PX -C /etc/lilo.conf 1> /dev/null 2> /dev/null
fi

################################################################

LINUX_PBR="`basename $PARTITION_LINUX`"

dialog --infobox "\nPBRをファイル化中..." 5 40
dd if=$PARTITION_LINUX of=$T_PX/boot/${LINUX_PBR}.pbr bs=512 count=1 \
1> /dev/null 2> /dev/null

################################################################

if [ "`cat $T_PX/boot/boot.ini|grep ${LINUX_PBR}.pbr`" = "" ] ; then
  echo "C:\\${LINUX_PBR}.pbr = \"Plamo Linux (${LINUX_PBR})\""$'\r'
>> $T_PX/boot/boot.ini
fi
cat $T_PX/boot/boot.ini|tr -d '\r' > $TMP/boot.ini$$

################################################################
dialog --title "新しい boot.ini の確認(日本語は文字化けします)" --textbox \
"$TMP/boot.ini$$" 22 74
rm -f $TMP/boot.ini$$

################################################################

  dialog --title "確認【重要】" \
--menu "boot.ini は $PARTITION_NT から作成し，\n\
LILO は $PARTITION_LINUX の PBR に書き込みました．\n\
\n\
とりあえず，現在の ${T_PX}boot/ 以下($PARTITION_LINUX の /boot/ 以下)\n\
に ${LINUX_PBR}.pbr と boot.ini を置きましたが，この2つのファイル\n\
はフロッピーなどに保存して，Windows の C:\\ 以下にコピーする\n\
必要があります(そうしないと Linux は起動しません)．\n\
どうしますか？\n\
このメニューの「FD」を選ぶと，フロッピーを Windows で読める\n\
形式でフォーマットし，${LINUX_PBR}.pbr と boot.ini を保存します．" \
19 65 3 \
"FD" "フロッピーに ${LINUX_PBR}.pbr と boot.ini とを保存" \
"Exit" "終了(後で自分でなんとかする)" \
"Begin" "最初からやりなおし" 2> $TMP/reply$$

if [ $? = 1 -o $? = 255 ]; then
  rm -f $TMP/reply$$
  exit
fi
REPLY="`cat $TMP/reply$$`"
rm -f $TMP/reply$$
NO_FD=0
if [ "$REPLY" = "Exit" ] ; then
  NO_FD=1
fi
if [ "$REPLY" = "Begin" ] ; then
  continue
fi

break

################################################################
done
################################################################

################################################################
if [ $NO_FD = 0 ] ; then
################################################################

clear
MOUNT_POINT_FD=`mount |grep "/dev/fd0 "|cut -f 3 -d ' '`
if [ ! "$MOUNT_POINT_FD" = "" ] ; then
  echo "$MOUNT_POINT_FD へのマウントを解除します．"
  umount $MOUNT_POINT_FD
  MPF=$MOUNT_POINT_FD
else
  MOUNT_POINT_FD=$TMP/fd$$
  MPF=""
fi

echo フロッピーディスクをセットして，Enterキーを押してください．
echo FATフォーマットされていないものは，ここでフォーマットします．
read ANS
clear
echo マウントしています...
if [ "$MPF" = "" ] ; then
  mkdir $MOUNT_POINT_FD
fi
mount -t vfat /dev/fd0 $MOUNT_POINT_FD
if [ ! $? = 0 ] ; then
while [ 1 ] ; do
  echo Enterキーでフォーマットを開始します．
  read ANS
  clear
  echo フロッピーを物理フォーマットしています...
  fdformat /dev/fd0u1440
  echo Windowsで読める形式でシステムフォーマットしています...
  mkdosfs /dev/fd0
  echo フォーマットをやりなおしますか？[y/N]
  read ANS
  if [ "$ANS" = "Y" -o "$ANS" = "y" ]; then
    continue
  fi
  break
done
echo マウントしています...
mount -t vfat /dev/fd0 $MOUNT_POINT_FD
fi
echo boot.ini と ${LINUX_PBR}.pbr をフロッピーにコピーしています...
cp $T_PX/boot/boot.ini $T_PX/boot/${LINUX_PBR}.pbr $MOUNT_POINT_FD/.
echo アンマウントしています...
umount $MOUNT_POINT_FD
if [ "$MPF" = "" ] ; then
  rmdir $MOUNT_POINT_FD
fi
echo 完了しました．Enterキーを押してください．
read ANS

dialog --title "完了" --msgbox \
"フロッピーに保存した boot.ini と ${LINUX_PBR}.pbr とを Windows の C:\\\n\
以下にコピーしてください．\n\
\n\
なお，カーネルの再構築をしたら，LILOを再インストールし，${LINUX_PBR}.pbr\n\
を作成しなおす必要があります．この部分はこの設定ツールを再び使う\n\
事でも可能です．インストール後，この設定ツールは osldrconfig\n\
コマンドでいつでも呼び出す事ができます．" \
12 70

################################################################
else
################################################################

dialog --title "完了" --msgbox \
"現在の ${T_PX}boot/ 以下($PARTITION_LINUX の /boot/ 以下)\n\
の boot.ini と ${LINUX_PBR}.pbr とを Windows の C:\\ 以下に\n\
コピーしてください．\n\
\n\
なお，カーネルの再構築をしたら，LILOを再インストールし，${LINUX_PBR}.pbr\n\
を作成しなおす必要があります．この部分はこの設定ツールを再び使う\n\
事でも可能です．インストール後，この設定ツールは osldrconfig\n\
コマンドでいつでも呼び出す事ができます．" \
12 70

################################################################
fi
################################################################

