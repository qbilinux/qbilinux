#!/bin/sh -x

######################################################################
vers=8.28
url="http://ftp.gnu.org/gnu/coreutils/coreutils-${vers}.tar.xz"
verify=
digest=
branch=
commitid=
pkgbase=installer
arch=`uname -m`
build=P1
src=coreutils-${vers}
patchfiles=""
OPT_CONFIG="--enable-no-install-program=chroot,hostid,nice,who,users"
OPT_CONFIG+=",pinky,uptime,stty,df,stdbuf,[,base64,base32,basename,cat"
OPT_CONFIG+=",chcon,chgrp,chmod,chown,cksum,comm,cp,csplit,cut,date,dd"
OPT_CONFIG+=",dir,dircolors,dirname,du,echo,env,expand,expr,factor"
OPT_CONFIG+=",false,fmt,fold,groups,head,id,join,kill,link,ln,logname"
OPT_CONFIG+=",md5sum,mkdir,mkfifo,mknod,mktemp,mv,nl,nproc,nohup,numfmt"
OPT_CONFIG+=",od,pathchk,pr,printenv,printf,ptx,pwd,readlink,realpath"
OPT_CONFIG+=",rm,rmdir,runcon,seq,sha1sum,sha224sum,sha256sum,sha384sum"
OPT_CONFIG+=",sha512sum,shred,shuf,sleep,sort,split,stat,sum,sync,tac"
OPT_CONFIG+=",tail,tee,test,timeout,touch,tr,true,truncate,tsort,tty"
OPT_CONFIG+=",uname,unexpand,uniq,unlink,vdir,wc,whoami,yes --without-gmp"
DOCS=""
template=20170713
tmplurl=ftp://plamo.linet.gr.jp/pub/Plamo-src/admin
######################################################################

if [ -f functions ] ; then
  source ./functions
elif [ ! -f /usr/share/plamo/functions ] ; then
  wget ftp://plamo.linet.gr.jp/pub/Plamo-src/admin/functions
  source ./functions
else
  source /usr/share/plamo/functions
fi

#fscheck
prepare "$@"
infodir=$P/share/info
mandir=$P/share/man
docdir=.
if [ $opt_download -eq 1 ] ; then
  download_sources
fi
if [ $opt_config -eq 1 ] ; then
  for i in `seq 0 $((${#B[@]} - 1))` ; do
    if [ -d ${B[$i]} ] ; then rm -rf ${B[$i]} ; fi ; cp -a ${S[$i]} ${B[$i]}
  done
  apply_patches
  cd ${B[$i]}
  cp -p po/Makevars{,.orig}
  sed -i 's@EXTRA_LOCALE_CATEGORIES@#&@g' po/Makevars
  cp -p gnulib-tests/Makefile.in{,.orig}
  sed -i -e 's@$(bin_PROGRAMS)@@g' \
      -e 's@$(man1_MANS)@@g' gnulib-tests/Makefile.in
  for i in `seq 0 $((${#B[@]} - 1))` ; do
  echo "***** config ******"
  echo $i
    cd ${B[$i]}
    if [ -x configure ] ; then
      ./configure --prefix= --sysconfdir=/etc --localstatedir=/var \
          --libdir='${exec_prefix}'/$libdir --infodir='${prefix}'/share/info \
          --mandir='${prefix}'/share/man ${OPT_CONFIG[$i]} \
          `[ $i -eq 9 ] && echo --with-rootdir=/$libdir` \
          `[ $i -eq 17 ] && echo --with-usrlibdir=/$libdir`
    fi
  done
fi
if [ $opt_build -eq 1 ] ; then
  for i in `seq 0 $((${#B[@]} - 1))` ; do
  echo "***** build ******"
  echo $i
    cd ${B[$i]}
    if [ -f [Mm]akefile ] ; then
      make LIBS="-ldl -static"
    fi
  done
fi
if [ $opt_package -eq 1 ] ; then
  root_priv
  if [ -d $P ] ; then rm -rf $P ; fi ; mkdir -p $P
  if [ -d $C ] ; then rm -rf $C ; fi ; mkdir -p $C
  touch $W/i.st ; sleep 1
  for i in `seq 0 $((${#B[@]} - 1))` ; do
  echo "***** package ******"
  echo $i
    cd ${B[$i]}
    if [ -f [Mm]akefile ] ; then
      make install DESTDIR=$P bin_PROGRAMS="src/ls src/paste" man1_MANS="man/ls.1 man/paste.1"
    fi
  done
fi
