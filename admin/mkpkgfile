#!/bin/bash

seek_dir () {
#    dfas dfa/fdafsd/fdafd/afkdjsakf/PlamoBuild*

    DIR=${1%/*}
    SCN=${1##*/}
    CAT=${DIR%/*}
    BASE=${DIR##*/}
    #echo $DIR
    #echo $SCN
    #echo $CAT
    #echo $BASE

    echo "pushd $DIR"
    pushd $DIR

    # check log file
    if [ $opt_check -eq 1 ] ; then
	echo "###### $DIR"
	if [ -f $BASE.make.log ] ; then
	    grep Error $BASE.make.log 
	else
	    echo "not make.log file"
	fi

	if [ -f $BASE.package.log ] ; then
	    grep Error $BASE.package.log 
	else
	    echo "not package.log file"
	fi
	
    # check Plamobuild script and make log.
    elif [ $opt_force -eq 1 ] || [ ! -f $BASE.make.log ] || [ $BASE.make.log -ot $SCN ] ; then
    
	# backup log file
	if [ -f $BASE.make.log.1 ] ; then
	    mv $BASE.make.log.1 $BASE.make.log.2
	fi
	if [ -f $BASE.package.log.1 ] ; then
	    mv $BASE.package.log.1 $BASE.package.log.2
	fi
	if [ -f $BASE.make.log ] ; then
	    mv $BASE.make.log $BASE.make.log.1
	fi
	if [ -f $BASE.package.log ] ; then
	    mv $BASE.package.log $BASE.package.log.1
	fi
	
	# execute
	sh ./$SCN download config build |& tee $BASE.make.log
	sudo sh ./$SCN package |& tee $BASE.package.log
    else
	echo "*** skip: make.log newer than PlamoBuild. If you want to build, use -f option."
    fi

    popd
}

if [ $# = 1 -o $# = 2 ] ; then

    opt_force=0
    opt_check=0
    while getopts fc OPT
    do
	case $OPT in
	    "f" ) opt_force=1 ;;
	    "c" ) opt_check=1 ;;
	esac
    done

    # cur option
    shift `expr $OPTIND - 1`

    seek_dir $1 ;
else
    echo "usage: $0 [-f] [buildscript_dir]"
fi

